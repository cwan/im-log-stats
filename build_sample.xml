<?xml version="1.0" encoding="UTF-8"?>
<project default="generate_report">

	<!-- 実行時クラスパス -->
	<path id="execute.classpath">
		<fileset dir="${basedir}/lib">
			<include name="*.jar" />
		</fileset>
	</path>

	<!-- カスタムタスク、ネスト要素の定義 -->
	<taskdef
		resource="net/mikaboshi/intra_mart/tools/log_stats/ant/taskdef.properties"
		classpathref="execute.classpath"
		loaderref="loader1" />

	<typedef
		resource="net/mikaboshi/intra_mart/tools/log_stats/ant/typedef.properties"
		classpathref="execute.classpath"
		loaderref="loader1" />

	<property name="log.dir" value="C:\imart\DebugServer_ds725\log" />

	<target name="generate_report">

		<!--
			imLogStatsタスク :
				iWP/iAF 6.x, 7.xのログを解析し、統計レポートを生成する。
				（リクエストログ、画面遷移ログ、例外ログのみ対応）

				@version :
					intra-martのバージョン (6.0|6.1|7.0|7.1|7.2)
					省略時 : 7.2

				@delay :
					ログファイルのパース中に挿入される遅延時間（ミリ秒）を指定する。
					リクエストログ・画面遷移ログは100件毎、例外ログは10ファイル毎。
					運用サーバ上で実行する場合、25～100程度を設定すると、時間はかかるがサーバに負荷をかけにくくなる。
					省略時 : 0

				備考 :
					・Ant実行中にOutOfMemoryErrorが発生する場合は、Antオプションで最大ヒープサイズを設定すること。
						例: set ANT_OPTS=-Xmx512m
						（ヒープ使用量は、ログが50万行でも100MBぐらい）
		-->
		<imLogStats version="7.2" delay="0">

			<!--
				imLogStatsのネスト要素parser :
					ログファイルのパースに関する設定。

					@charset :
						ログファイルの文字コード。
						（Ver.6.xではIMシステム文字コード、Ver.7.xではIM実行環境のJVMの文字コード）
						省略時 : Ant実行環境のJVMデフォルト文字コード

					@begin :
						開始日時（これより前のログは切り捨てる）
						許可される形式 :
						・yyyy/MM/dd HH:mm
						・yyyy-MM-dd HH:mm
						・yyyy/MM/dd
						・yyyy-MM-dd
						（時刻を省略した場合は00:00が補完される）
						省略時 : 下限なし

					@end :
						終了日時（これより後のログは切り捨てる）
						許可される形式
						・yyyy/MM/dd HH:mm
						・yyyy-MM-dd HH:mm
						・yyyy/MM/dd
						・yyyy-MM-dd
						（時刻を省略した場合は24:00が補完される）
						省略時 : 上限なし
			-->
			<parser
				charset="Windows-31J"
				begin="2011/11/15"
				end="2012/11/20 20:00">

				<!--
					parserのネスト要素requestLogLayout :
						リクエストログのレイアウトパターンを設定する。
						Ver.6.xでは、imart.xmlの以下の値
							/intra-mart/platform/service/application/log/request/file/@format
						Ver.7.xでは、im_logger_request.xmlの以下の値
							/included/appender[@name="REQUEST_FILE"]/layout/pattern
						省略時 : imLogStats/@versionに指定したバージョンの標準レイアウト
				-->
				<requestLogLayout>
					[%d{yyyy-MM-dd HH:mm:ss.SSS}]	[%thread]	%X{log.report.sequence}	%-5level	%logger{255}	%X{log.id}	-	%X{client.session.id}	%X{request.remote.host}	%X{request.method}	%X{request.url}	%X{request.query_string}	%X{request.url.referer}	%X{request.page.time}	%X{request.accept.time}	%X{request.id}%nopex%n
				</requestLogLayout>

				<!--
					parserのネスト要素transitionLogLayout :
						画面遷移ログのレイアウトパターンを設定する。
						Ver.6.xでは、imart.xmlの以下の値
							/intra-mart/platform/service/application/log/transition/file/@format
						Ver.7.xでは、im_logger_transition.xmlの以下の値
							/included/appender[@name="TRANSITION_FILE"]/layout/pattern
						省略時 : imLogStats/@versionに指定したバージョンの標準レイアウト
				-->
				<transitionLogLayout>
					[%d{yyyy-MM-dd HH:mm:ss.SSS}]	[%thread]	%X{log.report.sequence}	%-5level	%logger{255}	%X{log.id}	-	%X{transition.log.type.id}	%X{request.remote.address}	%X{request.remote.host}	%X{transition.access.user.id}	%X{client.session.id}	%X{transition.path.page.next}	%X{transition.time.response}	%X{transition.exception.name}	%X{transition.exception.message}	%X{transition.path.page.previous}	%X{request.id}%nopex%n
				</transitionLogLayout>

			</parser>

			<!--
				imLogStatsのネスト要素report :
					統計レポートに関する設定。

					@type :
						レポートファイルの形式（html|template|csv|tsv）
						（htmlはtemplateのエイリアス）
						省略時 : template

					@span :
						期間別統計の集計間隔（分）
						省略時 : 5分

					@sessionTimeout :
						IM環境のセッションタイムアウト時間（分）
						（有効セッション数の計算に利用する）
						省略時 : 10

					@requestPageTimeRankSize :
						リクエスト処理時間総合ランクの行数
						省略時 : 20

					@requestUrlRankSize :
						リクエストURL別・処理時間合計ランクの行数
						省略時 : 20

					@sessionRankSize :
						セッション別・処理時間合計ランクの行数
						省略時 : 20

					@name :
						レポートの名称
						（タイトル等に使用する）
						省略時 : intra-mart ログ統計レポート

					@signature :
						レポートの署名
						省略時 : なし

					@output :
						レポートの出力先ファイルパス
						省略時 : カレントディレクトリ/report_yyyyMMdd-HHmmss

					@charset
						レポートファイルの文字コード
						省略時 : Ant実行環境のJVMデフォルト文字コード

					@template
						カスタムテンプレートのファイルパス（FreeMarkerのテンプレート）
						省略時 : デフォルトテンプレート（@type="html" || "template"以外の場合は無視される）

					@templateCharset
						カスタムテンプレートファイルの文字コード
						省略時 : Ant実行環境のJVMデフォルト文字コード（@type="html"|| "template"以外の場合および@templateを指定していない場合は無視される）

			-->
			<report
				type="html"
				span="5"
				sessionTimeout="60"
				requestPageTimeRankSize="100"
				requestUrlRankSize="100"
				sessionRankSize="100"
				name="ログ統計レポート（サンプル）"
				signature="テスト"
				output="./report.html"
				charset="Windows-31J"
				templateCharset="Windows-31J" />

			<!--
				imLogStatsのネスト要素requestLogFiles, transitionLogFiles, exceptionLogFiles :
					解析対象のリクエストログファイル、画面遷移ログファイル、例外ログファイルを指定する。
					（各々、複数記述可能）
					形式は、Ant標準の<fileset>と同じ。（http://ant.apache.org/manual/Types/fileset.html）
					省略時 : ログを解析しない
			-->
			<requestLogFiles dir="${log.dir}/platform">
				<include name="request*.log"/>
			</requestLogFiles>

			<transitionLogFiles dir="${log.dir}/platform">
				<include name="transition*.log"/>
			</transitionLogFiles>

			<exceptionLogFiles dir="${log.dir}/platform/exception">
				<include name="exception*.log"/>
			</exceptionLogFiles>

		</imLogStats>

	</target>

</project>